name: Darwin Binary Cache

on: [push, pull_request, workflow_dispatch]
jobs:
    nix:
        name: 'Build'
        # Since I don't have a MacOS machine, we take advantage of microslop's infra
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  submodules: recursive

            - uses: cachix/install-nix-action@v31
              with:
                  github_access_token: ${{ secrets.GITHUB_TOKEN }}
                  extra_nix_config: |
                      accept-flake-config = true

            - uses: DeterminateSystems/flakehub-cache-action@main
            - uses: cachix/cachix-action@v16
              with:
                  name: matt-darwin
                  authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

            - name: Build darwin config
              run: |
                  nix build .#darwinConfigurations.MGCOMP0192.system
                  sudo ./result/sw/bin/darwin-rebuild switch --flake .#MGCOMP0192
